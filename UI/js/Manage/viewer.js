function get_watermark_canvas(kwargs){if(kwargs.waterprint_text){var watermark_size=kwargs.waterprint_size||20,watermark_text=kwargs.waterprint_text.replace(/\r\n/g,"\n"),watermark_font=kwargs.waterprint_font||"宋体",watermark_text_items=watermark_text.split("\n"),watermark_height=watermark_text_items.length*watermark_size/1.2,watermark_width=0,watermark_rotation=kwargs.waterprint_rotation||-20;var text_width=0;var rotate_height=0;var textcanvas=document.createElement("canvas");if(!textcanvas.getContext){return}var textctx=textcanvas.getContext("2d");textctx.font=watermark_size+"px"+" "+watermark_font;for(var row=0;row<watermark_text_items.length;row++){text_width=textctx.measureText(watermark_text_items[row]).width+25;if(row==0&&watermark_rotation<0){rotate_height=Math.tan(-watermark_rotation*Math.PI/180)*text_width}if(text_width>watermark_width){watermark_width=text_width}}var canvas=document.createElement("canvas");canvas.height=watermark_height+rotate_height;canvas.width=watermark_width;var ctx=canvas.getContext("2d");ctx.rotate(watermark_rotation/100);ctx.fillStyle=kwargs.waterprint_color;ctx.font=watermark_size+"px"+" "+watermark_font;ctx.globalAlpha=kwargs.waterprint_alpha;for(var row=0;row<watermark_text_items.length;row++){ctx.fillText(watermark_text_items[row],0,row*watermark_size+rotate_height)}return canvas}}function onloadHandle(identify,url,serverURL,allowPrint,imageURL,ext){var url=url+"&subfile=";var frameDocument=window.frames[identify+"-frame-content"].document;var scriptTag=frameDocument.createElement("script");scriptTag.src=serverURL+"/static/parent.js";var head=frameDocument.getElementsByTagName("head")[0];head.appendChild(scriptTag);var replaceAddress=function(el,url,serverURL){if(!el.notAppend){var linkTag=el.createElement("link");linkTag.href=serverURL+"/static/preview.css";linkTag.rel="stylesheet";var head=el.getElementsByTagName("head")[0];head.appendChild(linkTag);el.notAppend=true}if(!allowPrint){el.oncontextmenu=function(){return false};el.onpaste=function(){return false};el.oncopy=function(){return false};el.oncut=function(){return false};el.onselectstart=function(){return false}}var trimStr=function(str){return str?str.replace(/^\s+|\s+$/g,""):""};var re=/^(https?|file|ftps?|mailto|javascript):|^(#|data:image\/[^;]{2,9};)|^\/{2,}/i;var tagsName=["link","a","img","frame","script"];for(var t=0;t<tagsName.length;t++){var elements=el.getElementsByTagName(tagsName[t]);for(var x=0;x<elements.length;x++){var obj=elements[x];if(tagsName[t]=="a"||tagsName[t]=="link"){var href=trimStr(obj.getAttribute("href",2));if(re.test(href)||!href){continue}else{if(imageURL){obj.href=imageURL.replace(/\$path/,href)}else{obj.href=url+href}}}else{var src=trimStr(obj.getAttribute("src",2));if(re.test(src)||!src){continue}else{if(tagsName[t]=="img"||tagsName[t]=="script"){if(imageURL){var rep=imageURL.replace(/\$path/,src);obj.src=rep}else{obj.src=url+src;if(EDOViewer.isMobile&&EDOViewer.previewPatterns["flash"].test(ext)){obj.width=el.body.clientWidth}}}else if(tagsName[t]=="frame"){obj.src=url+src+"&disposition=inline";var callback=function(event){var frame=event.srcElement?event.srcElement:event.target;var frameSrc=frame.getAttribute("src",2);frameSrc=frameSrc.replace(frameSrc.split("/").pop(),"");var frameDocument=frame.contentDocument||frame.document;if(frame.name=="frTabs"){frameDocument.notAppend=true}replaceAddress(frameDocument,frameSrc,serverURL);if(frameDocument.body&&frame.name!="frTabs"){frameDocument.body.innerHTML=frameDocument.body.innerHTML.replace(/&lt;!\[endif\]&gt;/g,"")}};if(window.attachEvent){obj.attachEvent("onload",callback)}else{obj.addEventListener("load",callback)}}}}}}};replaceAddress(frameDocument,url,serverURL);var childNodes=frameDocument.body.childNodes;if(childNodes.length>1){if(!-[1]){var pagesNode=childNodes[0]}else{var pagesNode=childNodes[1]}if(pagesNode.tagName=="CENTER"&&/[First pageBackContinueLast page]/.test(pagesNode.innerHTML)){var aList=pagesNode.getElementsByTagName("a");for(var x=0;x<aList.length;x++){aList[x].setAttribute("style","padding: 0px 6px;background: #e6f2fe;color: #333;text-decoration: none;border: 1px solid #5d9cdf;")}var pagesHTML=pagesNode.innerHTML;pagesHTML=pagesHTML.replace("First page","首页").replace("Back","上页").replace("Continue","下页").replace("Last page","尾页").replace("Text","文本").replace("Graphics","图片");pagesNode.innerHTML=pagesHTML}}if(frameDocument.getElementsByTagName("frame").length==0&&frameDocument.getElementById("page-container")==null){}}function render_html_viewer(url,identify,kwargs){var callback=kwargs.callback;if(!callback){ajaxRequest(0,url,"html",identify,kwargs,"HEAD");return}var height=kwargs.height||490;var allowPrint=eval(kwargs.allow_print)==false?false:true;var serverURL=kwargs.server_url;var waterprintText=kwargs.waterprint_text||"";var name=identify+"-frame-content";var ext=kwargs.ext;if(/(html|rst|md)$/.test(kwargs.ext)){var imageURL=kwargs.image_url}else{var imageURL=""}var createFrame=function(data){var $iframe=$("<iframe>").attr("name",name).attr("id",name).attr("height",height-25).css({width:"99%",border:"1px solid #c3c3c3"}).on("load",function(){$iframe.contents().find("body").html(data);onloadHandle(identify,url,serverURL,allowPrint,imageURL,ext)});$("#"+identify).html($iframe);var canvas=get_watermark_canvas(kwargs);if(canvas){$iframe.css("background-image","url("+canvas.toDataURL("image/png")+")")}};if($.browser.msie&&window.XDomainRequest){if(window.XDomainRequest){var xdr=new XDomainRequest;var query=url;if(xdr){xdr.onload=function(){createFrame(xdr.responseText)};xdr.open("GET",query,true);xdr.send()}}}else{$.get(url,function(data){createFrame(data)})}}function render_box_viewer(url,identify,kwargs){var callback=kwargs.callback;url=url.replace(/(mime=)application\/x-shockwave-flash-x/,"$1text/x-paged-html");var serverURL=kwargs.server_url;var allowCopy=eval(kwargs.allow_copy)==false?false:true;var splitList=url.split("?");var url=splitList[0];var queryParams=splitList[1];var height=kwargs.height;var lang=EDOViewer.langs[kwargs.lang];var obj=$("#"+identify).attr("id",identify).css({height:height,overflow:"auto",width:"100%"});var viewer=Crocodoc.createViewer(obj,{url:url,enableTextSelection:true,plugins:{loadPage:{},print:{}},autoloadFirstPage:false,queryParams:queryParams,enableDragging:false,conversionIsComplete:false});obj.on("destroyed",function(){viewer.destroy()});obj.on("highlight",function(event,data){obj.find(".crocodoc-page-content:visible").unmark({element:"span"});var $pg=obj.find(".crocodoc-page-content").eq(data.page-1);if($pg.is(":visible")){$pg.mark(data.text,{element:"span",className:"highlight",acrossElements:true})}});var $input=$('<input type="text" style="height: inherit;width: 55px;text-align: center;padding: 5px;line-height: 15px;">');viewer.on("ready",function(event){var controls=$('<div class="preview-controls preview-actions"></div>');var allowPrint=eval(kwargs.allow_print)==false?false:true;if(allowPrint&&!EDOViewer.isMobile){controls.append($('<img id="'+identify+'-print" src="'+serverURL+'/static/print2.png" title="'+lang["print"]+'">').data("pages",event.data.numPages).click(function(){viewer.print()}))}controls.append($('<img src="'+serverURL+'/static/zoom-in2.png" title="'+lang["zoom_in"]+'">').click(function(){viewer.destroyPage($input.data("page"));viewer.zoom(Crocodoc.ZOOM_IN)}));controls.append($('<img src="'+serverURL+'/static/zoom-out2.png" title="'+lang["zoom_out"]+'">').click(function(){viewer.zoom(Crocodoc.ZOOM_OUT)}));controls.append($('<img src="'+serverURL+'/static/prev2.png" title="'+lang["prev"]+'">').click(function(){viewer.scrollTo(Crocodoc.SCROLL_PREVIOUS)}));controls.append($input.data({page:event.data.page,numPages:event.data.numPages}).val(event.data.page+" / "+event.data.numPages).focus(function(){$(this).val("")}).blur(function(){var data=$(this).data();$(this).val(data.page+" / "+data.numPages)}).keyup(function(){var $ths=$(this);var $val=$ths.val();if(!/^([1-9]\d*)$/.test($ths.val())){return}else{window.setTimeout(function(){if($val==$ths.val()){viewer.scrollTo($ths.val());$ths.val("")}},250)}}));controls.append($('<img src="'+serverURL+'/static/next2.png" title="'+lang["next"]+'">').click(function(){viewer.scrollTo(Crocodoc.SCROLL_NEXT)}));viewer.setLayout(kwargs.layout);if(obj.width()<=767){viewer.zoom(Crocodoc.ZOOM_AUTO)}else{var firstPage=obj.find(".crocodoc-page:first");if(firstPage.height()>firstPage.width()){viewer.zoom(Crocodoc.ZOOM_FIT_WIDTH)}else{viewer.zoom(Crocodoc.ZOOM_AUTO)}}var bookmark=$(obj).data("bookmark");if(window.localStorage&&bookmark){try{var pageData=JSON.parse(window.localStorage.getItem(bookmark));var page=pageData.page;if(page>1&&page<event.data.numPages){var message=$("<span>"+lang["last_view_page"].replace(/{page}/,page)+"  "+'<a href="#" onclick="Crocodoc.getViewer(Crocodoc.getViewerCount()).scrollTo('+page+");"+"$(this).closest('.jquery-message').hide();return false;\">"+lang["continue_view"]+"</a></span>");$().message(message.prop("outerHTML"),"info")}}catch(ex){}}var oldCSS={position:obj.css("position"),height:obj.css("height"),top:obj.css("top"),left:obj.css("left"),"z-index":obj.css("z-index")};var screen=$('<img src="'+serverURL+'/static/fullscreen2.png" title="'+lang["fullscreen"]+'">').click(function(){if(!obj.data("isFullScreen")){obj.css({position:"fixed",height:$(window).height(),top:0,left:0,"z-index":3e3}).data("isFullScreen",true);$("body").css("overflow","hidden");screen.attr("src",serverURL+"/static/cancelfullscreen2.png").attr("title",lang["back"])}else{obj.css(oldCSS).data("isFullScreen",false);$("body").css("overflow","visible");screen.attr("src",serverURL+"/static/fullscreen2.png").attr("title",lang["fullscreen"])}});$(document).keyup(function(e){if(e.keyCode===27){if(obj.data("isFullScreen")){screen.trigger("click");e.stopPropagation()}}});controls.append(screen);controls.append('<img src="'+serverURL+'/static/search2.png" style="vertical-align: middle;display:none;" '+'id="'+identify+'-h5search" onclick="$(this).hide().next().show().find(&quot;input&quot;).focus();" />'+'<span style="display: none;margin-left: 10px;">'+'<input style="width: 120px;padding: 0 3px;" id="'+identify+'-h5search-input" />'+'<a href="javascript:;" style="margin-left: -30px;" '+'onclick="$(this).parent().hide();$(this).parent().prev().show();">'+'<img src="'+serverURL+'/static/close.png" style="vertical-align: middle;" /></a></span>');controls.append($('<img src="'+serverURL+'/static/rotate2.png" title="'+lang["rotate"]+'">').click(function(){var $pg=obj.find(".crocodoc-page-content").eq($input.data("page")-1);$pg.find("img").rotate({angle:90,direction:true,scale:true,speed:.5})}));if(event.data.links&&event.data.links.length>0){var menu=$('<img src="'+serverURL+'/static/menu2.png" title="'+lang["menu"]+'">');menu.css({position:"absolute",top:"4px",left:"0"});menu.on("click",function(){var $menu=$("#"+identify+"-menu");if($menu.is(":visible")){$menu.hide()}else{$menu.show()}});obj.find(".crocodoc-viewport").on("click",function(){$("#"+identify+"-menu").hide()});var getMenu=function(items,sub){if(sub){var $menu=$('<ul style="padding-left: 20px;">')}else{var $menu=$('<ul class="" id="'+identify+'-menu">')}$.each(items,function(){if($.isArray(this)){$menu.append(getMenu(this,true))}else{var page=this.page;var link=$('<a href="#">'+this.title+"</a>").on("click",function(){viewer.scrollTo(page);return false});$menu.append($("<li>").append(link))}});return $menu};controls.append(menu);controls.append(getMenu(event.data.links).css({display:"none",height:obj.height()/1.5,overflow:"auto",width:obj.width()/2,position:"absolute",top:44,"z-index":1,"text-align":"left",left:12,padding:10,"box-shadow":"1px 1px 1px #9e9e9e","background-color":"rgba(255,255,255,0.8)"}))}obj.prepend($('<div class="preview-controls-wrapper"></div>').html(controls));if(obj.find(".preview-actions").is(":visible")){obj.find(".crocodoc-viewport").css("top",44)}var viewerCount=Crocodoc.getViewerCount();if(viewerCount>1){Crocodoc.getViewer(viewerCount-1).destroyCSS()}obj.on("destroyed",function(){if(viewerCount-1>0){Crocodoc.getViewer(viewerCount-1).restoreCSS()}});obj.trigger("page-initial",{viewer:"h5"})});var canvas=get_watermark_canvas(kwargs);viewer.on("pageload",function(event){var $pg=obj.find(".crocodoc-page-content").eq(event.data.page-1);var $pc=$pg.find(".pc");if(!allowCopy){$pg.addClass("crocodoc-page-no-select").bind("contextmenu",function(){return false})}var reloadCSS=function(){if($pc.is(":hidden")){$pg.addClass("crocodoc-page-loading");viewer.reloadCSS(function(){if($pc.is(":hidden")){window.setTimeout(reloadCSS,1e3)}})}else{viewer.reloadCSS(function(tmp){if(tmp){window.setTimeout(reloadCSS,2e3)}})}};reloadCSS();if(canvas){var $wm=$('<div style="width:100%;height:100%;position:relative;"></div>');$wm.css("background-image","url("+canvas.toDataURL("image/png")+")");var $bg=$pc.find("img");if($bg.length>0){$bg.after($wm)}else{$pc.prepend($wm)}}$pg.on("click",{page:event.data.page},function(event){var ths=$(this),pageX=event.pageX-ths.offset().left,pageY=event.pageY-ths.offset().top;Viewer(identify).trigger("position",{page_number:event.data.page,x_persent:Math.round(pageX/ths.width()*1e4)/100,y_persent:Math.round(pageY/ths.height()*1e4)/100})});var searchInput=$("#"+identify+"-h5search-input");if(searchInput.is(":visible")&&searchInput.val()){obj.trigger("highlight",{page:event.data.page,text:searchInput.val()})}$pg.find('a[href^="#pf"]').on("click",function(event){event.preventDefault();var page=$(this).data("dest-detail")[0];viewer.scrollTo(page)})});viewer.on("pagefocus",function(event){var page=event.data.page;var numPages=event.data.numPages;viewer.loadPage(page);if(page+2<=numPages){window.setTimeout(function(){viewer.loadPage(page+1)},10);window.setTimeout(function(){viewer.loadPage(page+2)},20)}$input.data("page",event.data.page).val(page+" / "+numPages)});viewer.on("scrollend",function(event){var bookmark=$(obj).data("bookmark");if(window.localStorage&&bookmark){var page=$input.data("page");if(page==0){window.localStorage.removeItem(bookmark)}else{window.localStorage.setItem(bookmark,JSON.stringify({page:$input.data("page"),timestamp:$.now()}))}}});viewer.load();viewer.on("asseterror",function(event){window.setTimeout(function(){viewer.load()},1e3)})}function render_flash_viewer(url,identify,kwargs){var width=kwargs.width||700;var height=kwargs.height||537;var allowPrint=eval(kwargs.allow_print)==false?false:true;var allowCopy=eval(kwargs.allow_copy)==false?false:true;var serverURL=kwargs.server_url;var bgcolor=kwargs.bgcolor||"#f4f4f4";var lang=EDOViewer.langs[kwargs.lang];var flashURL=kwargs.flash_url||"https://get.adobe.com/cn/flashplayer/";var node=document.getElementById(identify);var cloneNode=node.cloneNode();var actions_width=/\d$/.test(width)?width+"px":width;var $actions=$('<div class="flash-actions" id="'+identify+'-topbar"></div>').css({display:"none",width:actions_width,"background-color":bgcolor}).attr("width",actions_width);if(node.style.textAlign="center"){$actions.css("margin","0 auto")}if(allowPrint){var printAction='<a class="action" href="javascript:;" title="'+lang["print"]+'" '+'id="'+identify+'-print"><img src="'+serverURL+'/static/print.png" /></a>'}else{var printAction=""}$actions.append('<a href="javascript:;" title="'+lang["prev"]+'" '+'onclick="Viewer(&quot;'+identify+'&quot;).prev();">'+'<img src="'+serverURL+'/static/prev.png" /></a>'+'<input onfocus="this.value=&quot;&quot;;" onblur="this.value=this.getAttribute(&quot;text&quot;)" '+'onkeyup="var ths=this;var val=this.value;'+"window.setTimeout(function(){"+"if(val == ths.value){Viewer(&quot;"+identify+"&quot;).scrollTo(ths.value);}"+'}, 250);" '+'id="'+identify+'-page" type="text" class="page-input" />'+'<a href="javascript:;" title="'+lang["next"]+'" '+'onclick="Viewer(&quot;'+identify+'&quot;).next();">'+'<img src="'+serverURL+'/static/next.png" /></a>'+printAction+'<a class="action" href="javascript:;" title="'+lang["zoom_in"]+'" '+'onclick="Viewer(&quot;'+identify+'&quot;).zoomIn();">'+'<img src="'+serverURL+'/static/zoom-in.png" /></a>'+'<a class="action" href="javascript:;" title="'+lang["zoom_out"]+'" '+'onclick="Viewer(&quot;'+identify+'&quot;).zoomOut();">'+'<img src="'+serverURL+'/static/zoom-out.png" /></a>'+'<a class="action" href="javascript:;" title="'+lang["fullscreen"]+'" id="'+identify+'-full" '+'onclick="Viewer(&quot;'+identify+'&quot;).fullScreen();">'+'<img src="'+serverURL+'/static/fullscreen.png" /></a>'+'<a class="action" href="javascript:;" title="'+lang["back"]+'" id="'+identify+'-exitFull" '+'onclick="Viewer(&quot;'+identify+'&quot;).exitFullScreen();" style="display:none;">'+'<img src="'+serverURL+'/static/cancelfullscreen.png" /></a>'+'<a class="action hide" href="javascript:;" id="'+identify+'-search" '+'onclick="$(this).hide().next().show().find(&quot;input&quot;).focus();">'+'<img src="'+serverURL+'/static/search.png"  /></a>'+'<span class="action hide"><input class="search-input" id="'+identify+'-search-input" />'+'<a class="search-input-close" href="javascript:;" '+'onclick="$(this).parent().hide();$(this).parent().prev().show();">'+'<img src="'+serverURL+'/static/close.png"  /></a></span>'+'<a class="action" href="javascript:;" title="'+lang["rotate"]+'" '+'onclick="Viewer(&quot;'+identify+'&quot;).rotate();">'+'<img src="'+serverURL+'/static/rotate.png" /></a>');var menu=$('<a class="menu" href="javascript:;" title="'+lang["menu"]+'"></a>');menu.append('<img src="'+serverURL+'/static/menu.png" />');menu.on("click",function(){var $menu=$("#"+identify+"-menu");if($menu.length>0){if($menu.is(":visible")){$menu.hide()}else{$menu.show()}}else{$actions.append(getMenu([]).append("<li>"+lang["loading"]+"</li>"));var jsonURL=decodeURIComponent(url);jsonURL=jsonURL.replace("&mime=application/x-shockwave-flash-x","&mime=application/json");var errorCount=0;var getJSON=function(){$.ajax({type:"GET",dataType:"json",url:jsonURL,success:function(data){if(data.links.length==0){$("#"+identify+"-menu").html(lang["no_menu_info"])}else{$("#"+identify+"-menu").replaceWith(getMenu(data.links))}},error:function(){var $menu=$("#"+identify+"-menu");if($("#"+identify+"-menu").length>0&&errorCount<EDOViewer.retryCount){window.setTimeout(function(){errorCount++;getJSON()},EDOViewer.intervalSecond*1e3)}}})};getJSON()}return false});var getMenu=function(items,sub){if(sub){var $menu=$('<ul style="padding-left: 20px;">')}else{var $menu=$('<ul class="" id="'+identify+'-menu">').css({height:height/1.5,overflow:"auto",width:$actions.width()/2,position:"absolute","z-index":1,"text-align":"left",padding:10,margin:10,"box-shadow":"1px 1px 1px #9e9e9e","background-color":"rgba(255,255,255,0.8)"})}$.each(items,function(){if($.isArray(this)){$menu.append(getMenu(this,true))}else{var page=this.page;var link=$('<a href="#">'+this.title+"</a>").on("click",function(){document.getElementById(identify).scrollTo(page);return false});$menu.append($("<li>").append(link))}});return $menu};$actions.append(menu);node.id=identify+"-container";$("#"+node.id).html($actions).append($(cloneNode));document.getElementById(identify).innerHTML='<div style="padding: 10px 0">'+lang["no_install_flash"].replace(/{flash_url}/,flashURL)+"</div>";var flashvars={};flashvars["swf_file"]=url;flashvars["subfile"]=true;flashvars["allow_print"]=allowPrint;flashvars["allow_copy"]=allowCopy;flashvars["allow_debug"]=false;if(kwargs.waterprint_text!=undefined){flashvars["waterprint_text"]=kwargs.waterprint_text;flashvars["waterprint_size"]=kwargs.waterprint_size;flashvars["waterprint_color"]=kwargs.waterprint_color;flashvars["waterprint_font"]=kwargs.waterprint_font;flashvars["waterprint_x"]=kwargs.waterprint_x;flashvars["waterprint_y"]=kwargs.waterprint_y;flashvars["waterprint_alpha"]=kwargs.waterprint_alpha;flashvars["waterprint_rotation"]=kwargs.waterprint_rotation}var params={menu:false,bgcolor:bgcolor,allowFullScreen:true,allowScriptAccess:"always",wmode:"opaque"};var attributes={name:identify};swfobject.embedSWF(serverURL+"/static/zviewer.swf?v=8",identify,width,height,"9.0.45",null,flashvars,params,attributes);Viewer(identify).on("fullscreen",function(){$("#"+node.id).fullscreen()});Viewer(identify).on("exitfullscreen",function(){$.fullscreen.exit()});Viewer(identify).on("page-scroll",function(event,data){$("#"+identify+"-menu").hide();$("#"+identify+"-page").val(data.page+" / "+data.total).attr("text",data.page+" / "+data.total).blur();var bookmark=$(node).data("bookmark");if(window.localStorage&&bookmark){if(data.page==1){window.localStorage.removeItem(bookmark)}else{window.localStorage.setItem(bookmark,JSON.stringify({page:data.page,timestamp:$.now()}))}}});Viewer(identify).on("page-initial",function(event,data){var topbar=document.getElementById(identify+"-topbar");topbar.style.display="";for(var x=0;x<topbar.childNodes.length;x++){var child=topbar.childNodes[x];if(child.tagName!="A"){continue}else{child.onmouseover=function(){this.firstChild.src=this.firstChild.getAttribute("src").replace(/(.*).png$/,"$12.png")};child.onmouseout=function(){this.firstChild.src=this.firstChild.getAttribute("src").replace(/(\d).png$/,".png")}}}document.getElementById(identify+"-page").value=1+" / "+data.total;document.getElementById(identify+"-page").setAttribute("text",1+" / "+data.total);$("#"+identify+"-print").data("pages",data.total).on("click",function(){Viewer(identify).print()});var bookmark=$(node).data("bookmark");if(window.localStorage&&bookmark){try{var pageData=JSON.parse(window.localStorage.getItem(bookmark));var page=pageData.page;if(page>1&&page<data.total){var message=$("<span>"+lang["last_view_page"].replace(/{page}/,page)+"  "+'<a href="#" onclick="document.getElementById(\''+identify+"').scrollTo("+page+");"+"$(this).closest('.jquery-message').hide();return false;\">"+lang["continue_view"]+"</a></span>");$().message(message.prop("outerHTML"),"info")}}catch(ex){}}for(var x=1;x<=3;x++){try{this.loadPage(x*3)}catch(ex){}}function thisMovie(movieName){if(navigator.appName.indexOf("Microsoft")!=-1){return window[movieName]}else{return document[movieName]}}var eventSupported=function(eventName,el){el=el||document.createElement("div");eventName="on"+eventName;var isSupported=eventName in el;if(el.setAttribute&&!isSupported){el.setAttribute(eventName,"return;");isSupported=typeof el[eventName]==="function"}el=null;return isSupported};var addEvent=function(obj,type,callback){if(obj.addEventListener){obj.addEventListener(type,callback,false)}else if(obj.attachEvent){obj.attachEvent("on"+type,callback)}};var type=eventSupported("mousewheel")?"mousewheel":"DOMMouseScroll";var wheel=function(obj,callback){addEvent(obj,type,function(event){event=event||window.event;var delta=0;if(event.wheelDelta){delta=event.wheelDelta/120;if(window.opera&&window.opera.version()<10)delta=-delta}else if(event.detail){delta=-event.detail/3}event.delta=Math.round(delta);callback.call(obj,event)})};wheel(document.getElementById(identify),function(e){thisMovie(identify).MOUSE_WHEEL_detail(e.delta)});$("#"+identify).trigger("page-initial",{viewer:"flash"})})}function render_compress_viewer(url,identify,kwargs){var callback=kwargs.callback;if(!callback){ajaxRequest(0,url,"compress",identify,kwargs,"GET");return}var height=kwargs.height;height=/\d$/.test(height)?height+"px":height;var data=kwargs.data;var serverURL=kwargs.server_url;var lang=EDOViewer.langs[kwargs.lang];function getChildHTML(children){var html="("+children.length+lang["items"]+')<ul style="padding-left: 25px;">'+renderHTML(children)+"</ul>";return html}function getDisplaySize(size){if(size==0){return"0 KB"}else if(size<=1024){return"1 KB"}else if(size>1048576){return Math.round(size/1048576*100)/100+" MB"}else{return Math.round(size/1024*100)/100+" KB"}}function renderHTML(current){var href_url=url.split("?");var params=href_url[1].split("&");var lastParams="";locationParams="";mimeParams="";for(var x=0;x<params.length;x++){var param=params[x];if(!param){continue}if(param.indexOf("mime=")==0){mimeParams="&"+param}else if(param.indexOf("filename=")==0){continue}else if(param.indexOf("location=")==0){locationParams=param}else{lastParams+="&"+param}}var html="";for(var child=0;child<current.length;child++){var children="";var path=encodeURIComponent(current[child]["path"]);if(current[child]["type"]=="folder"){if(current[child]["children"].length>0){children=getChildHTML(current[child]["children"])}}if(kwargs.download_signcode){var down_url=serverURL+"/@@download?"+locationParams+"$$$"+path+lastParams;down_url=down_url.replace(/signcode=.*(&.*)|signcode=.*/,"signcode="+kwargs.download_signcode+"$1");var download='<span style="margin-left: 20px;">'+'<img src="'+serverURL+'/static/download.gif" style="vertical-align: middle;">'+"<a href="+down_url+' title="'+lang["download"]+'">'+lang["download"]+"</a></span>"}else{var download=""}var size="";if(current[child]["size"]){size=getDisplaySize(current[child]["size"])}if(current[child]["type"]=="folder"){html+='<li style="list-style-type: none;">'+'<img src="'+serverURL+'/static/folder.gif" style="vertical-align: middle;">'+'<span style="margin:0 5px;">'+current[child]["name"]+"</span>"+children+size+"</li>"}else{var preview_url=serverURL+"/@@view?"+locationParams+"$$$"+path+mimeParams+lastParams;preview_url=preview_url.replace(/signcode=/,"preview_signcode=");preview_url+="&pdf_signcode="+kwargs.pdf_signcode;preview_url+="&download_signcode="+kwargs.download_signcode;preview_url+="&server_url="+kwargs.server_url;preview_url+="&waterprint_text="+encodeURIComponent(kwargs.waterprint_text);preview_url+="&allow_copy="+kwargs.allow_copy;preview_url+="&allow_print="+kwargs.allow_print;preview_url+="&params="+JSON.stringify(kwargs.params);html+='<li style="list-style-type: none;">'+'<img src="'+serverURL+'/static/file.png" style="vertical-align: middle;">'+"<a href="+preview_url+' target="_blank" title="'+lang["preview"]+'" style="margin: 0 5px;">'+current[child]["name"]+"</a>"+'<span style="">['+size+"]</span>"+children+download+"</li>"}}return html}var html=renderHTML(data["children"]);if(kwargs.attachment&&data["children"].length>0){document.getElementById(identify).innerHTML='<ul style="text-align: left;">'+'<li style="color: #888;">'+lang["attachment"]+"("+data["children"].length+")</li>"+html+"</ul>"}else{document.getElementById(identify).innerHTML='<ul style="text-align: left;max-height: '+height+';overflow: auto;">'+html+"</ul>"}}function render_audio_viewer(url,identify,kwargs){var width="80%";var serverURL=kwargs.server_url;var supportHTML5=typeof Worker!=="undefined";var lang=EDOViewer.langs[kwargs.lang];var flashURL=kwargs.flash_url||"https://get.adobe.com/cn/flashplayer/";var noInstallInfo=lang["no_install_flash"].replace(/{flash_url}/,flashURL)+"</div>";var $obj=$("#"+identify);if(supportHTML5){var primary="html5"}else if(!swfobject.getFlashPlayerVersion()["major"]){$obj.html(noInstallInfo);return}else{var primary="flash"}var $loading=$("<div></div>").hide();$obj.html($("<center></center>").append($("<center></div>").attr("id",identify+"-player")).append($loading));jwplayer.key="lzyNU9Lr9SFs/f1DlEawhnAfUHPFu4klHnebLA==";var playerInstance=jwplayer(identify+"-player").setup({file:url,type:"mp3",width:width,height:40,flashplayer:serverURL+"/static/jwplayer/jwplayer.flash.swf",html5player:serverURL+"/static/jwplayer/jwplayer.html5.js",primary:primary});playerInstance.onReady(function(event){var count=0;playerInstance.onError(function(event){if(count==2){count=0;$loading.show().text(event.message)}else{$loading.show().text(lang["play_fail"]);window.setTimeout(function(){$loading.hide();playerInstance.play();count++},3e3)}});playerInstance.onPlay(function(event){$(document).trigger("jwplay")});$(document).trigger("jwdestroy")})}function render_video_viewer(url,identify,kwargs){var url=url;var width="80%";var height=kwargs.height||330;var ext=kwargs.ext;var serverURL=kwargs.server_url;var supportHTML5=typeof Worker!=="undefined";var type=kwargs.mode=="flv"?"flv":"mp4";var lang=EDOViewer.langs[kwargs.lang];var flashURL=kwargs.flash_url||"https://get.adobe.com/cn/flashplayer/";var noInstallInfo=lang["no_install_flash"].replace(/{flash_url}/,flashURL)+"</div>";var $obj=$("#"+identify);if(supportHTML5){var primary="html5"}else if(!swfobject.getFlashPlayerVersion()["major"]){$obj.html(noInstallInfo);return}else{var primary="flash"}var render=function(){if(ext==".swf"){var html=$("<object>").attr({width:width,height:height,classid:'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"',codebase:"http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0",id:identify+"-swf-player"}).css({width:width,height:height}).append('<param name="allowScriptAccess" value="sameDomain" />').append('<param name="movie" value='+url+" />").append('<param name="quality" value="high" />').append('<param name="bgcolor" value="#ffffff" />').append('<param name="wmode" value="transparent" />').append($("<embed>").attr({src:url,width:width,height:height,quality:"high",bgcolor:"#ffffff",wmode:"transparent",allowScriptAccess:"sameDomain",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer"}).css({width:width,height:height}));$obj.html(html)}else{var $loading=$("<div></div>").hide();$obj.html($("<center></center>").append($("<div></div>").attr("id",identify+"-player")).append($loading));jwplayer.key="lzyNU9Lr9SFs/f1DlEawhnAfUHPFu4klHnebLA==";var playerInstance=jwplayer(identify+"-player").setup({file:url,image:image,type:type,width:width,height:height,bufferlength:5,flashplayer:serverURL+"/static/jwplayer/jwplayer.flash.swf",html5player:serverURL+"/static/jwplayer/jwplayer.html5.js",primary:primary});playerInstance.onReady(function(event){var count=0;playerInstance.onError(function(event){if(count==2){count=0;$loading.show().text(event.message)}else{$loading.show().text(lang["play_fail"]);window.setTimeout(function(){$loading.hide();playerInstance.play();count++},3e3)}});playerInstance.onPlay(function(event){$(document).trigger("jwplay")});$(document).trigger("jwdestroy")})}};if(ext!=".mp4"){var image=url.replace(/signcode=.*(&.*)/,"signcode="+kwargs.preview_signcode+"$1")+"&mime=image/x-thumbnail-png&subfile=image_large";render()}else{var image="";var dataURL=url.replace("&mime=video/mp4","&mime=application/x-metadata-json");var successFunc=function(data){if(data.video_encoding=="h264"){render()}else{url=url.replace("&source_mime=video%2Fmp4","&source_mime=video/x-mp4b");render()}};var failFunc=function(errorCount){if($("#"+identify).length==0)return;if(errorCount<EDOViewer.retryCount){window.setTimeout(function(){getData(errorCount+1)},EDOViewer.intervalSecond*1e3)}else{$obj.html(lang["timeout"])}};var getData=function(errorCount){$obj.html($("<div>"+lang["converting"]+"</div>").append($("<img>").attr("src",serverURL+"/static/waiting.gif")));if($.browser.msie&&window.XDomainRequest){if(window.XDomainRequest){var xdr=new XDomainRequest;if(xdr){xdr.onload=function(){var data=xdr.responseText?JSON.parse(xdr.responseText):{};successFunc(data)};xdr.onerror=function(){failFunc(errorCount)};xdr.open("GET",dataURL,true);xdr.send()}}}else{$.ajax({type:"GET",url:dataURL,dataType:"json",success:function(data){successFunc(data)},error:function(){failFunc(errorCount)}})}};var errorCount=0;getData(errorCount)}}function render_image_viewer(url,identify,kwargs){var callback=kwargs.callback;var src=url;var serverURL=kwargs.server_url;var lang=EDOViewer.langs[kwargs.lang];var allowPrint=eval(kwargs.allow_print)==false?false:true;if(kwargs.download_signcode){var download=url.replace(/(signcode=).*/,"$1"+kwargs.download_signcode);if(kwargs.filesize<300*1024){src=download}}else{var download=""}var $obj=$("#"+identify);var $image=$("<img>").attr("src",src).css({transition:"all 0.5s ease-in-out 0s"});var $loading=$("<div>"+lang["converting"]+"</div>").append($("<img>").attr("src",serverURL+"/static/waiting.gif"));$obj.html($image).append($loading);var errorCount=0;$image.bind("error",function(){$image.hide();$loading.show();errorCount+=1;if(errorCount<EDOViewer.retryCount){window.setTimeout(function(){$image.show().attr("src",src+"&_="+$.now())},1e3*EDOViewer.intervalSecond)}else{$loading.html(lang["timeout"])}});$image.bind("contextmenu",function(){return false});$image.load(function(){$loading.hide();var title=kwargs.filename||new RegExp("[?&]location=([^&#]*)").exec(url)[1].replace(/.*%2F/,"");var $viewer=$("<div></div>").css({position:"relative",overflow:"auto",margin:"0 auto",width:kwargs.width,textAlign:"center"}).append($image);var $rotate=$("<img>").attr("src",serverURL+"/static/rotation.gif").attr("title",lang["rotate"]).css({position:"relative",top:5,"z-index":1,cursor:"pointer"}).on("click",function(event){$image.rotate({angle:90,direction:true,speed:.5})});var $print=$("<img>").attr("src",serverURL+"/static/print.gif").attr("title",lang["print"]).css({position:"relative",top:5,"z-index":1,cursor:"pointer"}).on("click",function(event){window.open(serverURL+"/fullscreenview.html?src="+encodeURIComponent(src)+"&action=print")});var $origin=$("<img>").attr("src",serverURL+"/static/originlabel.gif").attr("title",lang["origin"]).css({position:"relative",top:5,"z-index":1,cursor:"pointer"}).on("click",function(event){window.open(serverURL+"/fullscreenview.html?src="+encodeURIComponent(download))});var $zoomIn=$("<img>").attr("src",serverURL+"/static/zoom-in.gif").attr("title",lang["zoom_in"]).css({position:"relative",top:5,"z-index":1,cursor:"pointer"}).on("click",function(event){var scale=150/100;var pos=$image.offset();var clickX=event.pageX-pos.left;var clickY=event.pageY-pos.top;$image.css({width:$image.width()*scale,height:$image.height()*scale})});var $actions=$('<div class="preview-actions">').css({"margin-bottom":10,"text-align":"center"}).append($zoomIn);var $zoomOut=$("<img>").attr("src",serverURL+"/static/zoom-out.gif").attr("title",lang["zoom_out"]).css({position:"relative",top:5,"z-index":1,cursor:"pointer"}).on("click",function(event){var scale=150/100;var pos=$image.offset();var clickX=event.pageX-pos.left;var clickY=event.pageY-pos.top;$image.css({width:$image.width()/scale,height:$image.height()/scale})});$actions.append($zoomOut);if(typeof Worker!=="undefined"){$actions.append($rotate)}if(allowPrint){$actions.append($print)}if(/^.(jpg|jpeg|png|gif|bmp)$/i.test(kwargs.ext)&&download){$actions.append($origin)}$obj.html($viewer).prepend($actions);var canvas=document.createElement("canvas");if(!!(canvas.getContext&&canvas.getContext("2d"))){$viewer.append(canvas);canvas.width=$image[0].naturalWidth;canvas.height=$image[0].naturalHeight;var ctx=canvas.getContext("2d");var watermark_canvas=get_watermark_canvas(kwargs);ctx.drawImage($image.get(0),0,0);var pat=ctx.createPattern(watermark_canvas,"repeat");ctx.rect(0,0,canvas.width,canvas.height);ctx.fillStyle=pat;ctx.fill();$image.remove();$image=$(canvas);$image.bind("contextmenu",function(){return false})}})}function callViewerEvent(type,objectID,data){Viewer(objectID).trigger(type,data)}var Viewer=function(identify){var obj=document.getElementById(identify);var on=function(type,func){var handler=function(event,data){event.data=data;func.apply(obj,[event,data])};$("html").on(type+identify,$(obj),handler)};var trigger=function(type,data){$(obj).trigger(type+identify,data)};var el=obj.parentNode;var changeStyle=function(flag){var topbar=el.firstChild;if(topbar.id==obj.id+"-topbar"){var is_html=false}else{var is_html=true}if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!flag){if(is_html){document.getElementById(obj.id+"-exitFull").style.display="none";document.getElementById(obj.id+"-full").style.display=""}else{el.style.width="";el.style.height="";topbar.style.width=topbar.getAttribute("width");document.getElementById(obj.id+"-exitFull").style.display="none";document.getElementById(obj.id+"-full").style.display="";obj.style.width="";obj.style.height=""}}else{if(is_html){document.getElementById(obj.id+"-exitFull").style.display="";document.getElementById(obj.id+"-full").style.display="none"}else{el.style.width="100%";el.style.height="100%";topbar.style.width="100%";document.getElementById(obj.id+"-exitFull").style.display="";document.getElementById(obj.id+"-full").style.display="none";obj.style.width="100%";obj.style.height="96%"}}};var fullScreen=function(){Viewer(identify).trigger("fullscreen");try{changeStyle(true)}catch(ex){}var requestMethod=el.requestFullScreen||el.webkitRequestFullScreen||el.mozRequestFullScreen||el.msRequestFullScreen;if(requestMethod){requestMethod.call(el);document.addEventListener("webkitfullscreenchange",function(e){changeStyle()},false);document.addEventListener("mozfullscreenchange",function(e){changeStyle()},false);document.addEventListener("fullscreenchange",function(e){changeStyle()},false)}};var exitFullScreen=function(){Viewer(identify).trigger("exitfullscreen");try{changeStyle()}catch(ex){}if(document.exitFullscreen){document.exitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}};var print=function(name){if(confirm("确认要打印吗？")){if(name){var src=document.getElementById(name).src;document.getElementById(name).src=src+"#print";window.setTimeout(function(){document.getElementById(name).src=src+"#"},1500)}else{obj.print()}Viewer(identify).trigger("print")}};return{on:on,trigger:trigger,fullScreen:fullScreen,exitFullScreen:exitFullScreen,zoomIn:function(){obj.zoomIn()},zoomOut:function(){obj.zoomOut()},heightFit:function(){obj.heightFit()},widthFit:function(){obj.widthFit()},print:function(name){print(name)},setMode:function(mode){obj.setMode(mode)},scrollTo:function(page){obj.scrollTo(page)},prev:function(){obj.prev()},next:function(){obj.next()},rotate:function(){obj.rotate()}}};