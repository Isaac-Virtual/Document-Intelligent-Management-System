(function(factory){if(typeof module==="object"&&typeof module.exports==="object"){module.exports=factory(require("jquery"),window,document)}else{window.tus=factory(jQuery,window,document)}})(function($,window,document,undefined){"use strict";var support=typeof File!=="undefined"&&typeof Blob!=="undefined"&&typeof FileList!=="undefined"&&(!!Blob.prototype.webkitSlice||!!Blob.prototype.mozSlice||!!Blob.prototype.slice||false);if(!support){return}var tus={upload:function(file,options){var upload=new ResumableUpload(file,options);if(file){upload._start()}return upload},fingerprint:function(file){return"tus-"+file.name+"-"+file.type+"-"+file.size}};function ResumableUpload(file,options){this.file=file;this.options={endpoint:options.endpoint,fingerprint:options.fingerprint,resumable:options.resumable!==undefined?options.resetBefore:true,resetBefore:options.resetBefore,resetAfter:options.resetAfter,headers:options.headers!==undefined?options.headers:{},chunkSize:options.chunkSize,signurl:options.signurl,index:options.index!==undefined?options.index:1,metadata:options.metadata||{}};this.options.headers["Tus-Resumable"]="1.0.0";this.fileUrl=null;this.bytesWritten=null;this._jqXHR=null;this._deferred=$.Deferred();this._deferred.promise(this)}ResumableUpload.prototype._start=function(){var self=this;if(!self.options.resumable||self.options.resetBefore===true){self._urlCache(false)}if(!(self.fileUrl=self._urlCache())){$.ajax({type:"GET",url:self.options.signurl,data:{filename:encodeURIComponent(self.file.rename||self.file.name),filesize:self.file.size,newrevision:self.file.newrevision,path:self.file.path},dataType:"json",success:function(json){self.options.metadata={callback_url:json["callback_url"]};self.options.endpoint=json["upload_server"]+self.options.endpoint;if(json["upload_service"]=="aliyun_oss"){load("aliyun-oss-sdk.js",function(){self._ossPut(json)})}else{self._post(json)}},error:function(XMLHttpRequest){if(XMLHttpRequest.status==409){self._emitFail("file exist")}else{self._emitFail(decodeURIComponent(XMLHttpRequest.statusText))}}})}else{self._head()}};ResumableUpload.prototype._ossPut=function(data){var self=this;self.bytesWritten=self.file.size*.01;self._emitProgress();var client=new OSS.Wrapper({accessKeyId:data.AccessKeyId,accessKeySecret:data.AccessKeySecret,stsToken:data.SecurityToken,endpoint:data.endpoint,bucket:data.bucket_name});var checkpoint;var progress=function(p,cpt){return function(done){self.bytesWritten=self.file.size*p;self._emitProgress();checkpoint=cpt;done()}};var num=0;var multipartUpload=function(){client.multipartUpload(data.key,self.file,{headers:{"x-oss-callback":data.callback},checkpoint:checkpoint,progress:progress}).then(function(result){self._emitDone()}).catch(function(error){if($(".popup-container #drop-upload").is(":visible")){num++;console.log("retry "+num+" times");multipartUpload()}else{console.log(error)}})};multipartUpload()};ResumableUpload.prototype._ossPost=function(data){var self=this;if(/^http[s]?:/i.test(data.endpoint)){var url=data.endpoint.split("//").join("//"+data.bucket_name+".")}else{var url="//"+data.bucket_name+"."+data.endpoint}var request=new FormData;request.append("OSSAccessKeyId",data.AccessKeyId);request.append("policy",data.policy);request.append("Signature",data.signature);request.append("x-oss-security-token",data.SecurityToken);request.append("callback",data.callback);request.append("key",data.key);request.append("file",self.file);$.ajax({url:url,data:request,processData:false,cache:false,contentType:false,type:"POST",xhr:function(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.onprogress=function(ev){if(ev.lengthComputable){self.bytesWritten=self.file.size*(ev.loaded/ev.total);self._emitProgress()}};return xhr}},success:function(data,textStatus,jqXHR){self._emitDone()},error:function(jqXHR,textStatus,errorThrown){if(self.file.size>50*1024*1024){self._emitFail("Could not post to file resource "+url+". "+textStatus+"<br>大文件上传，使用桌面助手上传更稳定")}else{self._emitFail("Could not post to file resource "+url+". "+errorThrown)}}})};ResumableUpload.prototype._post=function(data){var self=this;var headers=$.extend({"Upload-Length":self.file.size},self.options.headers);var metadataHeader=this._generateMetadata();if(metadataHeader.length>0){headers["Upload-Metadata"]=metadataHeader}var options={type:"POST",data:data,url:self.options.endpoint,headers:headers};$.ajax(options).fail(function(jqXHR,textStatus,errorThrown){self._emitFail("Could not post to file resource "+self.options.endpoint+". "+textStatus)}).done(function(data,textStatus,jqXHR){var location=jqXHR.getResponseHeader("Location");if(!location){return self._emitfail("could not get url for file resource. "+textStatus)}self.fileUrl=location;self._uploadFile(0)})};ResumableUpload.prototype._head=function(){var self=this;var options={type:"HEAD",url:this.fileUrl,cache:false,headers:self.options.headers};$.ajax(options).fail(function(jqXHR,textStatus,errorThrown){if(jqXHR.status==404){self._post()}else{self._emitFail("Could not head at file resource: "+textStatus)}}).done(function(data,textStatus,jqXHR){var offset=jqXHR.getResponseHeader("Upload-Offset");var bytesWritten=offset?parseInt(offset,10):0;self._uploadFile(bytesWritten)})};ResumableUpload.prototype._uploadFile=function(range_from){var self=this;this.bytesWritten=range_from;this._urlCache(self.fileUrl);this._emitProgress();var bytesWrittenAtStart=this.bytesWritten;var range_to=self.file.size;if(self.options.chunkSize){range_to=Math.min(range_to,range_from+self.options.chunkSize)}var slice=self.file.slice||self.file.webkitSlice||self.file.mozSlice;var blob=slice.call(self.file,range_from,range_to,self.file.type);var xhr=$.ajaxSettings.xhr();var headers=$.extend({"Upload-Offset":range_from,"Content-Type":"application/offset+octet-stream"},self.options.headers);var options={type:"PATCH",url:self.fileUrl,data:blob,processData:false,contentType:self.file.type,cache:false,xhr:function(){return xhr},headers:headers};$(xhr.upload).bind("progress",function(e){self.bytesWritten=bytesWrittenAtStart+e.originalEvent.loaded;self._emitProgress(e)});this._jqXHR=$.ajax(options).fail(function(jqXHR,textStatus,errorThrown){var msg=jqXHR.responseText||textStatus||errorThrown;self._emitFail(msg)}).done(function(){if(range_to===self.file.size){if(self.options.resetAfter===true){self._urlCache(false)}self._emitDone()}else{self._uploadFile(range_to)}})};ResumableUpload.prototype.stop=function(){if(this._jqXHR){this._jqXHR.abort()}};ResumableUpload.prototype._emitProgress=function(e){this._deferred.notifyWith(this,[e,this.options.index,this.bytesWritten,this.file.size])};ResumableUpload.prototype._emitDone=function(){this._deferred.resolveWith(this,[this.fileUrl,this.file])};ResumableUpload.prototype._emitFail=function(err){try{err=JSON.parse(err).message}catch(ex){}this._deferred.rejectWith(this,[err,this.file])};ResumableUpload.prototype._urlCache=function(url){var fingerPrint=this.options.fingerprint;if(fingerPrint===undefined){fingerPrint=tus.fingerprint(this.file)}if(url===false){return localStorage.removeItem(fingerPrint)}if(url){var result=false;try{result=localStorage.setItem(fingerPrint,url)}catch(e){}return result}return localStorage.getItem(fingerPrint)};ResumableUpload.prototype._generateMetadata=function(){var elements=[];var metadata=this.options.metadata;for(var key in metadata){if(metadata.hasOwnProperty(key)){elements.push(key+" "+btoa(metadata[key]))}}return elements.join(",")};return tus});