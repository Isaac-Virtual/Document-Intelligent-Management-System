(function($){jQuery.event.props.push("dataTransfer");var default_opts={data:{},drop:empty,signurl:empty,submitElement:empty,uploadElement:empty,closeElement:empty,dropElement:empty,dragStart:empty,dragEnter:empty,dragOver:empty,dragLeave:empty,docEnter:empty,docOver:empty,docLeave:empty,afterAll:empty,error:function(err,file,i,status){alert(err)},start:empty,end:empty,uploadStarted:empty,uploadFinished:empty,uploadErrored:empty,progressUpdated:empty},errors=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed","NotFound","NotReadable","AbortError","ReadError","FileExtensionNotAllowed","OverQuotaError"];$.fn.filedrop=function(options){var opts=$.extend({},default_opts,options),global_progress=[],doc_leave_timer,stop_loop=false,files_count=0,filesDone=0,filesFail=0,files=[];this.unbind("drop").unbind("dragstart").unbind("dragenter").unbind("dragover").unbind("dragleave");this.bind("drop",drop).bind("dragstart",opts.dragStart).bind("dragenter",dragEnter).bind("dragover",dragOver).bind("dragleave",dragLeave);if(opts.dropElement.length){opts.dropElement.unbind("drop").unbind("dragstart").unbind("dragenter").unbind("dragover").unbind("dragleave");opts.dropElement.bind("drop",drop).bind("dragstart",opts.dragStart).bind("dragenter",dragEnter).bind("dragover",dragOver).bind("dragleave",dragLeave)}this.unbind("cancelupload");this.bind("cancelupload",cancelUpload);if(opts.uploadElement.length){opts.uploadElement.change(function(e){for(var x=0;x<this.files.length;x++){if(this.webkitdirectory){var pathArr=this.files[x].webkitRelativePath.split("/");pathArr.pop();this.files[x].path=encodeURIComponent(pathArr.join("/"))}files.push(this.files[x])}files_count=files.length;upload();$(this).val("")})}if(opts.closeElement.length){opts.closeElement.unbind("click").click(function(e){if(files_count>0){opts.afterAll(true)}files=[];files_count=0})}function cancelUpload(e,i){files.splice(i,1);files_count=files.length}function drop(e){var pending;if(opts.drop.call(this,e)===false||e.dataTransfer===undefined)return false;function scanFiles(item){var pathArr=item.fullPath.replace(/^\//,"").split("/");pathArr.pop();var path=encodeURIComponent(pathArr.join("/"));if(item.isDirectory){var directoryReader=item.createReader();var fnReadEntries=function(entries){entries.forEach(function(entry){scanFiles(entry)});if(entries.length>0){directoryReader.readEntries(fnReadEntries)}};directoryReader.readEntries(fnReadEntries)}else{item.file(function(file){file.path=path;files.push(file);files_count=files.length;if(pending===undefined){upload();pending=true}else{opts.uploadStarted(files_count,file,files_count)}})}}var items=e.dataTransfer.items;if(items&&items[0]&&items[0].webkitGetAsEntry){for(var i=0;i<items.length;i++){var item=items[i].webkitGetAsEntry();if(item){scanFiles(item)}}}else{files=$.merge(files,e.dataTransfer.files);files_count=files.length;upload()}e.preventDefault();return false}function upload(){stop_loop=false;if(!files){opts.error(errors[0]);return false}var tusUpload=function(file,index,retry){var options={endpoint:"/api/v1/upload/upload_resumable",signurl:opts.signurl,resume:false,index:index,chunkSize:4*1024*1024,resetBefore:true};tus.upload(file,options).fail(function(error,file){opts.uploadErrored(error,file);filesFail++;if(filesFail&&filesFail+filesDone==files_count||files_count==0){opts.end()}}).always(function(){if(retry===undefined){index++;if(index!=files_count){tusUpload(files[index],index)}}}).progress(function(e,index,bytesUploaded,bytesTotal){opts.progressUpdated(index,files[index],Math.round(bytesUploaded*100/bytesTotal))}).done(function(url,file){opts.uploadFinished(file);filesDone++;if(filesDone===files_count){opts.afterAll()}if(filesFail&&filesFail+filesDone==files_count||files_count==0){opts.end()}});file.index=index;file.upload=tusUpload};for(var i=0;i<files_count;i++){opts.uploadStarted(i,files[i],files_count)}if(opts.submitElement.length){opts.submitElement.unbind("click").click(function(){if(files_count>0){if(files_count>300){$().message("单次最多可上传300个文件，推荐采用桌面助手上传，或分次上传","warning")}else{filesDone=0;filesFail=0;opts.start(files_count);tusUpload(files[0],0)}}})}}function afterAll(){files=[];files_count=0;return opts.afterAll()}function dragEnter(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.dragEnter.call(this,e)}function dragOver(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.docOver.call(this,e);opts.dragOver.call(this,e)}function dragLeave(e){clearTimeout(doc_leave_timer);opts.dragLeave.call(this,e);e.stopPropagation()}function docDrop(e){e.preventDefault();opts.docLeave.call(this,e);return false}function docEnter(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.docEnter.call(this,e);return false}function docOver(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.docOver.call(this,e);return false}function docLeave(e){doc_leave_timer=setTimeout(function(_this){return function(){opts.docLeave.call(_this,e)}}(this),200)}return this};function empty(){}})(jQuery);